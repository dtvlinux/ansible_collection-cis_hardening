---
- name: Create volume group
  community.general.lvg:
    vg: hardening_vg
    pvs: "{{ hardening.configure_filesystem_partitions.disk }}"

- name: Create logical volumes
  community.general.lvol:
    vg: hardening_vg
    lv: "{{ item.key | regex_replace('^/', '') | regex_replace('/', '_') }}_lv"
    size: "{{ item.value.size }}"
  loop: "{{ hardening.configure_filesystem_partitions.partitions | dict2items }}"
  when: item.key != '/dev/shm'
  register: lvol_result

- name: Create filesystem on logical volumes
  community.general.filesystem:
    fstype: "{{ item.value.fstype | default('ext4') }}"
    dev: "/dev/hardening_vg/{{ item.key | regex_replace('^/', '') | regex_replace('/', '_') }}_lv"
  loop: "{{ hardening.configure_filesystem_partitions.partitions | dict2items }}"
  when: item.key != '/dev/shm'
  register: mkfs_result

- name: Check if LV is currently mounted
  ansible.builtin.command: grep -q -E " {{ item.key }} " /proc/mounts
  register: is_mounted_check
  changed_when: false
  failed_when: false
  loop: "{{ hardening.configure_filesystem_partitions.partitions | dict2items }}"
  when: item.key != '/dev/shm'

- name: Create temporary mount point only if migration is needed
  ansible.builtin.file:
    path: "/mnt/tmp{{ item.key | regex_replace('/', '_') }}"
    state: directory
    mode: '0755'
  loop: "{{ hardening.configure_filesystem_partitions.partitions | dict2items }}"
  when:
    - item.key != '/dev/shm'
    - is_mounted_check.results | selectattr('item.key', 'equalto', item.key) | map(attribute='rc') | first == 1
  register: tmp_dir_result

- name: Mount new LV to temporary location
  ansible.builtin.command: >-
    mount -t {{ item.value.fstype | default('ext4') }} 
    -o defaults
    /dev/hardening_vg/{{ item.key | regex_replace('^/', '') | regex_replace('/', '_') }}_lv 
    /mnt/tmp{{ item.key | regex_replace('/', '_') }}
  loop: "{{ hardening.configure_filesystem_partitions.partitions | dict2items }}"
  when:
    - item.key != '/dev/shm'
    - tmp_dir_result.results | selectattr('item.key', 'equalto', item.key) | list | length > 0
    - is_mounted_check.results | selectattr('item.key', 'equalto', item.key) | map(attribute='rc') | first == 1
  register: tmp_mount_result
  changed_when: tmp_mount_result.rc == 0
  failed_when: tmp_mount_result.rc != 0 and 'already mounted' not in tmp_mount_result.stderr | default('')

- name: Check if source directory exists before rsync
  ansible.builtin.stat:
    path: "{{ item.key }}"
  loop: "{{ hardening.configure_filesystem_partitions.partitions | dict2items }}"
  when: item.key != '/dev/shm'
  register: source_stat
  changed_when: false

- name: Copy data from old location to new LV (only on first run)
  ansible.builtin.command: >-
    rsync -aAXH --delete --exclude=lost+found
    {{ item.key }}/
    /mnt/tmp{{ item.key | regex_replace('/', '_') }}/
  loop: "{{ hardening.configure_filesystem_partitions.partitions | dict2items }}"
  when:
    - item.key != '/dev/shm'
    - tmp_mount_result.results | selectattr('item.key', 'equalto', item.key) | map(attribute='rc') | first | default(1) == 0
    - source_stat.results | selectattr('item.key', 'equalto', item.key) | map(attribute='stat.exists') | first | default(false)
  register: rsync_result
  changed_when: rsync_result.rc == 0
  failed_when: rsync_result.rc != 0

- name: Unmount temporary mount point after copy
  ansible.posix.mount:
    path: "/mnt/tmp{{ item.key | regex_replace('/', '_') }}"
    state: unmounted
  loop: "{{ hardening.configure_filesystem_partitions.partitions | dict2items }}"
  when:
    - item.key != '/dev/shm'
    - tmp_mount_result.results | selectattr('item.key', 'equalto', item.key) | map(attribute='rc') | first | default(1) == 0
  ignore_errors: true

- name: Ensure fstab entry points to the new logical volume
  ansible.posix.mount:
    path: "{{ item.key }}"
    src: "/dev/hardening_vg/{{ item.key | regex_replace('^/', '') | regex_replace('/', '_') }}_lv"
    fstype: "{{ item.value.fstype | default('ext4') }}"
    opts: "{{ item.value.options | default('defaults') }}"
    state: present
    fstab: /etc/fstab
  loop: "{{ hardening.configure_filesystem_partitions.partitions | dict2items }}"
  when: item.key != '/dev/shm'
  register: fstab_result

- name: Remove only files (not directories) from original location
  ansible.builtin.shell: >-
    find {{ item.key }} -mindepth 1 -maxdepth 1 -type f -delete &&
    find {{ item.key }} -mindepth 1 -maxdepth 1 -type l -delete
  loop: "{{ hardening.configure_filesystem_partitions.partitions | dict2items }}"
  when:
    - item.key != '/dev/shm'
    - rsync_result.results | selectattr('item.key', 'equalto', item.key) | map(attribute='changed') | first | default(false)
  changed_when: true

- name: Flag reboot as required if fstab was changed
  ansible.builtin.set_fact:
    reboot_required: true
  when: fstab_result.results | selectattr('changed', 'equalto', true) | list | length > 0

- name: Remove temporary mount points after successful migration
  ansible.builtin.file:
    path: "/mnt/tmp{{ item.key | regex_replace('/', '_') }}"
    state: absent
  loop: "{{ hardening.configure_filesystem_partitions.partitions | dict2items }}"
  when:
    - item.key != '/dev/shm'
    - rsync_result.results | selectattr('item.key', 'equalto', item.key) | map(attribute='changed') | first | default(false)
  ignore_errors: true
