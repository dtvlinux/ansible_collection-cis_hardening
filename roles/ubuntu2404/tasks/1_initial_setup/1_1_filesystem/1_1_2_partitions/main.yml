---
- name: 1.1.2 | Configure filesystem partitions | Dedicated disk checks
  when: cis_ubuntu2404_dedicated_disk_apply | bool
  tags: always
  block:
    - name: 1.1.2 | Configure filesystem partitions | Resolve dedicated disk symlinks
      ansible.builtin.stat:
        path: "{{ cis_ubuntu2404_dedicated_disk_device }}"
      register: disk_stat

    - name: 1.1.2 | Configure filesystem partitions | Register dedicated disk size
      ansible.builtin.set_fact:
        disk_size_bytes: >-
          {% set disk_name = disk_stat.stat.lnk_source | default(disk_stat.stat.path) | basename %}
          {{ ansible_facts['devices'][disk_name]['size'] | ansible.builtin.human_to_bytes }}

    - name: 1.1.2 Configure filesystem partitions | Dedicated disk space check
      ansible.builtin.assert:
        that: disk_size_bytes | float >= cis_ubuntu2404_required_bytes | float
        fail_msg: >
          Insufficient space on {{ cis_ubuntu2404_dedicated_disk_device }}.
          Required: {{ (cis_ubuntu2404_required_bytes | int) | ansible.builtin.human_readable }}
          Available: {{ (disk_size_bytes | int) | ansible.builtin.human_readable }}
        success_msg: "Space check passed for {{ cis_ubuntu2404_dedicated_disk_device }}."

- name: 1.1.2 | Configure filesystem partitions | Dedicated disk include tasks
  when: cis_ubuntu2404_dedicated_disk_apply | bool
  block:
    - name: 1.1.2.1 | Configure /tmp | Include dedicated disk tasks
      when: >
        cis_ubuntu2404_dedicated_disk_tmp_apply | bool
        and
        (ansible_facts['mounts'] | selectattr('mount', 'equalto', '/tmp') | map(attribute='device') | first | default(''))
        !=
        ("/dev/mapper/" ~ (cis_ubuntu2404_dedicated_disk_vgname | replace('-', '--'))
        ~ "-" ~
        (cis_ubuntu2404_dedicated_disk_tmp_lvol | replace('-', '--')))
      ansible.builtin.include_tasks:
        file: 1_1_2_1_configure_tmp_dedicated_disk.yml
      register: dedicated_tmp_result

    - name: 1.1.2.3 | Configure /home | Include dedicated disk tasks
      when: >
        cis_ubuntu2404_dedicated_disk_home_apply | bool
        and
        (ansible_facts['mounts'] | selectattr('mount', 'equalto', '/home') | map(attribute='device') | first | default(''))
        !=
        ("/dev/mapper/" ~ (cis_ubuntu2404_dedicated_disk_vgname | replace('-', '--'))
        ~ "-" ~
        (cis_ubuntu2404_dedicated_disk_home_lvol | replace('-', '--')))
      ansible.builtin.include_tasks:
        file: 1_1_2_3_configure_home_dedicated_disk.yml
      register: dedicated_home_result
    
    - name: 1.1.2.4 | Configure /var | Include dedicated disk tasks
      when: >
        cis_ubuntu2404_dedicated_disk_var_apply | bool
        and
        (ansible_facts['mounts'] | selectattr('mount', 'equalto', '/var') | map(attribute='device') | first | default(''))
        !=
        ("/dev/mapper/" ~ (cis_ubuntu2404_dedicated_disk_vgname | replace('-', '--'))
        ~ "-" ~
        (cis_ubuntu2404_dedicated_disk_var_lvol | replace('-', '--')))
      ansible.builtin.include_tasks:
        file: 1_1_2_4_configure_var_dedicated_disk.yml
      register: dedicated_var_result

- name: 1.1.2 | Configure filesystem partitions | Existing partition include tasks
  block:
    - name: 1.1.2.1 | Configure /tmp | Detect /tmp mount state
      ansible.builtin.command:
        cmd: mountpoint -q /tmp
      register: tmp_mount_check
      failed_when: false
      changed_when: false

    - name: 1.1.2.1 | Configure /tmp | Include existing partition tasks
      when:
        - >
          not cis_ubuntu2404_dedicated_disk_apply | bool
          or not cis_ubuntu2404_dedicated_disk_tmp_apply | bool
          or (dedicated_tmp_result is skipped)
        - tmp_mount_check.rc == 0
      ansible.builtin.include_tasks:
        file: 1_1_2_1_configure_tmp_existing_partition.yml

    - name: 1.1.2.2 | Configure /dev/shm | Include partition tasks
      when: cis_ubuntu2404_dev_shm_apply | bool
      ansible.builtin.include_tasks:
        file: 1_1_2_2_configure_dev_shm_partition.yml

    - name: 1.1.2.3 | Configure /home | Detect /home mount state
      ansible.builtin.command:
        cmd: mountpoint -q /home
      register: home_mount_check
      failed_when: false
      changed_when: false

    - name: 1.1.2.3 | Configure /home | Include existing partition tasks
      when:
        - >
          not cis_ubuntu2404_dedicated_disk_apply | bool
          or not cis_ubuntu2404_dedicated_disk_tmp_apply | bool
          or (dedicated_home_result is skipped)
        - home_mount_check.rc == 0
      ansible.builtin.include_tasks:
        file: 1_1_2_3_configure_home_existing_partition.yml
    
    - name: 1.1.2.4 | Configure /var | Detect /var mount state
      ansible.builtin.command:
        cmd: mountpoint -q /var
      register: var_mount_check
      failed_when: false
      changed_when: false

    - name: 1.1.2.4 | Configure /var | Include existing partition tasks
      when:
        - >
          not cis_ubuntu2404_dedicated_disk_apply | bool
          or not cis_ubuntu2404_dedicated_disk_tmp_apply | bool
          or (dedicated_var_result is skipped)
        - var_mount_check.rc == 0
      ansible.builtin.include_tasks:
        file: 1_1_2_4_configure_var_existing_partition.yml


    # - name: 1.1.2.4.1 | Ensure /var is a separate partition
    #   when: cis_ubuntu2404_dedicated_disk_var_apply
    #   dtvlinux.cis_hardening.dedicated_disk_partition:
    #     path: /var
    #     device: "{{ cis_ubuntu2404_dedicated_disk_device }}"
    #     vg: "{{ cis_ubuntu2404_dedicated_disk_vgname }}"
    #     lv: "{{ cis_ubuntu2404_dedicated_disk_var_lvol }}"
    #     size: "{{ cis_ubuntu2404_dedicated_disk_var_size }}"
    #     fstype: "{{ cis_ubuntu2404_dedicated_disk_var_type }}"
    #     sync: true
    
    # - name: 1.1.2.5.1 | Ensure /var/tmp is a separate partition
    #   when: cis_ubuntu2404_dedicated_disk_var_tmp_apply
    #   dtvlinux.cis_hardening.dedicated_disk_partition:
    #     path: /var/tmp
    #     device: "{{ cis_ubuntu2404_dedicated_disk_device }}"
    #     vg: "{{ cis_ubuntu2404_dedicated_disk_vgname }}"
    #     lv: "{{ cis_ubuntu2404_dedicated_disk_var_tmp_lvol }}"
    #     size: "{{ cis_ubuntu2404_dedicated_disk_var_tmp_size }}"
    #     fstype: "{{ cis_ubuntu2404_dedicated_disk_var_tmp_type }}"
    #     sync: true
    
    # - name: 1.1.2.6.1 | Ensure /var/log is a separate partition
    #   when: cis_ubuntu2404_dedicated_disk_var_log_apply
    #   dtvlinux.cis_hardening.dedicated_disk_partition:
    #     path: /var/log
    #     device: "{{ cis_ubuntu2404_dedicated_disk_device }}"
    #     vg: "{{ cis_ubuntu2404_dedicated_disk_vgname }}"
    #     lv: "{{ cis_ubuntu2404_dedicated_disk_var_log_lvol }}"
    #     size: "{{ cis_ubuntu2404_dedicated_disk_var_log_size }}"
    #     fstype: "{{ cis_ubuntu2404_dedicated_disk_var_log_type }}"
    #     sync: true
    
    # - name: 1.1.2.7.1 | Ensure /var/log/audit is a separate partition
    #   when: cis_ubuntu2404_dedicated_disk_var_log_audit_apply
    #   dtvlinux.cis_hardening.dedicated_disk_partition:
    #     path: /var/log/audit
    #     device: "{{ cis_ubuntu2404_dedicated_disk_device }}"
    #     vg: "{{ cis_ubuntu2404_dedicated_disk_vgname }}"
    #     lv: "{{ cis_ubuntu2404_dedicated_disk_var_log_audit_lvol }}"
    #     size: "{{ cis_ubuntu2404_dedicated_disk_var_log_audit_size }}"
    #     fstype: "{{ cis_ubuntu2404_dedicated_disk_var_log_audit_type }}"
    #     sync: true


